#!/usr/bin/env ruby

# Add the lib directory to the load path when running from source
if __FILE__ == $PROGRAM_NAME
  lib_path = File.expand_path('../../lib', __FILE__)
  $LOAD_PATH.unshift(lib_path) if File.directory?(lib_path)
end

begin
  require 'llm_bench'
rescue LoadError
  # If we can't load the gem, try to load from source
  require_relative '../lib/llm_bench'
end

require 'yaml'
require 'optparse'

def parse_arguments
  options = {}
  OptionParser.new do |opts|
    opts.banner = "Usage: llm_bench --provider PROVIDER --model NICKNAME [--print-result]"
    opts.banner += "\n       llm_bench --all [--track] [--print-result]"

    opts.on('--provider PROVIDER', 'Provider name from config file') do |provider|
      options[:provider] = provider
    end

    opts.on('--model NICKNAME', 'Model nickname from config file') do |model|
      options[:model] = model
    end

    opts.on('--all', 'Run benchmark on all configured models') do
      options[:all] = true
    end

    opts.on('--track', 'Enable continuous tracking with CSV output (requires --all)') do
      options[:track] = true
    end

    opts.on('--print-result', 'Print the full message returned by each LLM') do
      options[:print_result] = true
    end

    opts.on('--help', 'Display help') do
      puts opts
      exit
    end
  end.parse!

  if options[:track] && !options[:all]
    puts "Error: --track requires --all"
    puts "Use --help for usage information"
    exit 1
  end

  if options[:all]
    options
  elsif options[:provider] && options[:model]
    options
  else
    puts "Error: Either --provider and --model, or --all is required"
    puts "Use --help for usage information"
    exit 1
  end

  options
end

def main
  options = parse_arguments

  if options[:all]
    config_path = File.join(Dir.home, '.llm_bench', 'models.yaml')
    config_path = './models.yaml' unless File.exist?(config_path)

    unless File.exist?(config_path)
      puts "Error: Configuration file not found. Expected at #{config_path}"
      exit 1
    end

    config = YAML.load_file(config_path)

    if options[:track]
      tracker = LLMBench::Tracker.new(config)
      tracker.start_tracking
    else
      parallel_benchmark = LLMBench::ParallelBenchmark.new(config, options[:print_result])
      parallel_benchmark.run_all
    end
  else
    benchmark = LLMBench::Benchmark.new(options[:provider], options[:model], options[:print_result])
    benchmark.run_benchmark
  end
rescue StandardError => e
  puts "Error: #{e.message}"
  exit 1
end

main
